<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis_mapper.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhsj.api.dao.TbOrderDao">
    <sql id="SELECT_FIELDS">
        id,order_id,plan_charge_amount,actual_charge_amount,status,discount_type,
        discount_id,pay_type,pay_method,store_no,parent_store_no,org_id,user_id,ctime,utime,org_ids,sale_id
    </sql>

    <insert id="insertOrder" >
        INSERT INTO tb_order
       (order_id,plan_charge_amount,actual_charge_amount,status,discount_type,discount_id,pay_type,pay_method,store_no,parent_store_no,org_id,user_id,ctime,utime,org_ids,sale_id,discount_ids)
        VALUES (#{bean.orderId},#{bean.planChargeAmount},#{bean.actualChargeAmount},#{bean.status},#{bean.discountType},
        #{bean.discountId},#{bean.payType},#{bean.payMethod},#{bean.storeNo},#{bean.parentStoreNo},#{bean.orgId},#{bean.userId},#{bean.ctime},#{bean.utime},#{bean.orgIds},#{bean.saleId},#{bean.discountIds})
    </insert>


    <update id="updateOrderByOrderId">
        UPDATE tb_order
        SET status = #{status},utime=unix_timestamp(now())
        where order_id = #{orderId}
    </update>

    <update id="updateOrderByOrderIdIde">
        UPDATE tb_order
        SET status = #{status},utime=unix_timestamp(now())
        where order_id = #{orderId} and status = #{preStatus}
    </update>

    <select id="getByOrderId" resultType="orderBean">
        SELECT <include refid="SELECT_FIELDS"/>
        FROM tb_order
        WHERE order_id = #{orderId}
    </select>

    <select id="getById" resultType="orderBean">
        SELECT <include refid="SELECT_FIELDS"/>
        FROM tb_order
        WHERE id = #{id}
    </select>

    <select id="getMSAliListByCtime" resultType="orderBean">
        SELECT <include refid="SELECT_FIELDS"/>
        FROM tb_order
        WHERE pay_type= 2 and pay_method = '2' and status = 0
        <if test=" id > 0">
            and id > #{id}
        </if>
        <if test=" ctime > 0">
            and ctime > #{ctime}
        </if>
        order by id
        limit #{pageSize}
    </select>


    <select id="countDealBySaleId" resultType="com.zhsj.api.bean.result.CountDealBean">
        SELECT COUNT(1) 'count',sum(actual_charge_amount) 'sum'
        FROM tb_order
        WHERE sale_id = #{saleId} and status = 1
        and ctime BETWEEN #{startTime} AND #{endTime}
    </select>

    <select id="countDealByStoreNo" resultType="com.zhsj.api.bean.result.CountDealBean">
        SELECT COUNT(1) 'count',sum(actual_charge_amount) 'sum'
        FROM tb_order
        WHERE store_no = #{storeNo} and status = 1
        and ctime BETWEEN #{startTime} AND #{endTime}
    </select>

    <select id="countDealByParentNo" resultType="com.zhsj.api.bean.result.CountDealBean">
        SELECT COUNT(1) 'count',sum(actual_charge_amount) 'sum'
        FROM tb_order
        WHERE parent_store_no = #{parentNO} and status = 1
        and ctime BETWEEN #{startTime} AND #{endTime}
    </select>

    <select id="getByParam" resultType="orderBean">
        SELECT <include refid="SELECT_FIELDS"/>
        FROM tb_order
        where 1=1
        <if test="storeNo != '' ">
            AND store_no = #{storeNo}
        </if>
        <if test="parentNo != '' ">
            AND parent_store_no = #{parentNo}
        </if>
        and ctime BETWEEN #{startTime} and #{endTime}
        <if test="payMethod != 0 ">
            AND pay_method = #{payMethod}
        </if>
        <choose>
            <when test="status != null and status.size() > 0">
                AND status IN
                <foreach collection="status" item="st"
                         open="(" separator="," close=")" >
                    #{st}
                </foreach>
            </when>
        </choose>
        ORDER by id DESC
        limit #{startNo},#{pageSize}
    </select>

    <select id="countByParam" resultType="com.zhsj.api.bean.result.CountDealBean">
        SELECT count(1) "count",sum(actual_charge_amount) "sum"
        FROM tb_order
        where 1=1
        <if test="storeNo != '' ">
            AND store_no = #{storeNo}
        </if>
        <if test="parentNo != '' ">
            AND parent_store_no = #{parentNo}
        </if>
        and ctime BETWEEN #{startTime} and #{endTime}
        <if test="payMethod != 0 ">
            AND pay_method = #{payMethod}
        </if>
        <choose>
            <when test="status != null and status.size() > 0">
                AND status IN
                <foreach collection="status" item="st"
                         open="(" separator="," close=")" >
                    #{st}
                </foreach>
            </when>
        </choose>
    </select>

    <select id="countDiscount" resultType="countDiscount">
        select sum(plan_charge_amount) plan_charge_amount ,sum(actual_charge_amount) actual_charge_amount
        from tb_order
        where discount_id = #{discountId} and status = 1
    </select>

    <select id="countDiscountUser" resultType="java.lang.Integer">
        select count(1) from (select DISTINCT(user_id)
        from tb_order
        where discount_id = #{discountId} and `status` = 1) a
    </select>

    <select id="countDiscountOrder" resultType="countDiscount">
         select sum(plan_charge_amount) plan_charge_amount ,sum(actual_charge_amount) actual_charge_amount,
         count(1) total
        from tb_order
        where discount_id = #{discountId} and status = 1
        AND ctime BETWEEN #{startTime} and #{endTime}
    </select>

    <select id="getDiscountOrder" resultType="orderBean">
        SELECT <include refid="SELECT_FIELDS"/>
        FROM tb_order
        where discount_id = #{discountId} and status = 1
        AND ctime BETWEEN #{startTime} and #{endTime}
        limit #{startNo},#{pageSize}
    </select>

    <!-- xlc 170306 -->
    <select id="getMemberCountByParam" parameterType="java.util.Map" resultType="java.lang.Integer">
      select count(distinct(user_id)) from tb_order
      <where>
        <if test="storeNo != null and storeNo != ''">
           store_no = #{storeNo}
        </if>
        <if test="startTime != null and endTime != null">
           and ctime between #{startTime} and #{endTime}
        </if>
      </where>
    </select>
    
    <select id="getCountByMoney" resultType="java.lang.Integer">
      select count(distinct(user_id)) from tb_order
      <where>
         store_no = #{storeNo}
         <if test="actualChargeAmount1 != null">
            and actual_charge_amount >= #{actualChargeAmount1}
         </if>
         <if test="actualChargeAmount2 != null">
            and actual_charge_amount &lt; #{actualChargeAmount2}
         </if>
      </where>
    </select>
    
    <select id="getCountByTime" resultType="java.lang.Integer">
       select count(1) from (
          select count(1) from tb_order where  store_no = #{storeNo}
          GROUP BY user_id having  
          <if test="time ==1">
             count(user_id) = 1
          </if>
          <if test="time == 2">
            (count(user_id) >= 2 and count(user_id) &lt;= 4)
          </if>
          <if test="time == 3">
            (count(user_id) >= 5 and count(user_id) &lt;= 8)
          </if>
          <if test="time == 4">
            count(user_id) >= 9
          </if>
          ) a
    </select>
        
        
     <select id="getByStoreNoAndUserId" resultType="com.zhsj.api.bean.result.CountMember">
       select count(1) count, sum(actual_charge_amount) sum from tb_order
       <where>
            store_no = #{storeNo} and user_id = #{userId}
       </where>
     </select>   
     
     <select id="getByStoreNoAndMoney" resultType="com.zhsj.api.bean.result.CountMember">
        select distinct(user_id) userId from tb_order
        <where>
	        store_no = #{storeNo}
	         <if test="actualChargeAmount1 != null">
	            and actual_charge_amount >= #{actualChargeAmount1}
	         </if>
	         <if test="actualChargeAmount2 != null">
	            and actual_charge_amount &lt; #{actualChargeAmount2}
	         </if>
        </where>
     </select>
     
     <select id="getByStoreNoAndTime" resultType="com.zhsj.api.bean.result.CountMember">
        select distinct(user_id) userId from tb_order where  store_no = #{storeNo}
          GROUP BY user_id having  
          <if test="time ==1">
             count(user_id) = 1
          </if>
          <if test="time == 2">
            (count(user_id) >= 2 and count(user_id) &lt;= 4)
          </if>
          <if test="time == 3">
            (count(user_id) >= 5 and count(user_id) &lt;= 8)
          </if>
          <if test="time == 4">
            count(user_id) >= 9
          </if>
     </select>
</mapper>